# 扩展开发模板

本模板展示如何创建 MicroBot 扩展（工具、通道、技能）。

## 目录结构

```
extensions/
├── tool/                  # 工具扩展
│   ├── my-tool/           # 你的工具目录
│   │   └── index.ts       # 工具实现
│   └── index.ts           # 工具导出入口
├── channel/               # 通道扩展
│   ├── my-channel/        # 你的通道目录
│   │   └── index.ts       # 通道实现
│   └── index.ts           # 通道导出入口
└── skills/                # 技能扩展
    ├── my-skill/          # 你的技能目录
    │   └── SKILL.md       # 技能定义
    └── index.ts           # 技能导出入口
```

---

## 一、创建工具扩展

### 1. 创建工具目录

```bash
mkdir extensions/tool/my-tool
```

### 2. 实现工具

```typescript
// extensions/tool/my-tool/index.ts
import { defineTool } from '@microbot/sdk';
import type { JSONSchema, ToolContext } from '@microbot/types';

/** 输入参数 Schema */
const inputSchema: JSONSchema = {
  type: 'object',
  properties: {
    message: {
      type: 'string',
      description: '要处理的消息',
    },
  },
  required: ['message'],
};

/** 我的工具 */
export const MyTool = defineTool({
  name: 'my_tool',
  description: '我的自定义工具',
  inputSchema,
  execute: async (input: { message: string }, ctx: ToolContext) => {
    // 实现你的工具逻辑
    return `处理结果: ${input.message}`;
  },
});
```

### 3. 导出工具

```typescript
// extensions/tool/index.ts
export { MyTool } from './my-tool';
```

---

## 二、创建通道扩展

### 1. 创建通道目录

```bash
mkdir extensions/channel/my-channel
```

### 2. 实现通道

```typescript
// extensions/channel/my-channel/index.ts
import { defineChannel, ChannelHelper } from '@microbot/sdk';
import type { Channel, OutboundMessage, MessageBus } from '@microbot/types';

/** 我的通道 */
export const MyChannel = defineChannel({
  name: 'my_channel',
  
  create: async (bus: MessageBus, config: Record<string, unknown>) => {
    const helper = new ChannelHelper(bus, config.allowFrom as string[] ?? []);
    
    return {
      name: 'my_channel' as const,
      isRunning: false,
      
      async start() {
        this.isRunning = true;
        // 初始化连接...
      },
      
      async stop() {
        this.isRunning = false;
        // 清理连接...
      },
      
      async send(msg: OutboundMessage) {
        // 发送消息到外部平台...
      },
    } satisfies Channel;
  },
});
```

### 3. 导出通道

```typescript
// extensions/channel/index.ts
export { MyChannel } from './my-channel';
```

---

## 三、创建技能扩展

### 1. 创建技能目录

```bash
mkdir extensions/skills/my-skill
```

### 2. 定义技能

```markdown
<!-- extensions/skills/my-skill/SKILL.md -->
---
name: my-skill
description: 我的自定义技能
version: 1.0.0
author: your-name
always: false
dependencies:
  - tool: read_file
  - tool: write_file
---

# 我的技能

这个技能可以做什么...

## 使用场景

- 场景1: ...
- 场景2: ...

## 注意事项

- 注意1
- 注意2
```

---

## 四、工具上下文

工具执行时接收 `ToolContext`:

```typescript
interface ToolContext {
  /** 当前通道 */
  channel: string;
  /** 当前聊天 ID */
  chatId: string;
  /** 工作目录（项目级） */
  workspace: string;
  /** 当前工作目录 */
  currentDir: string;
  /** 发送消息到总线 */
  sendToBus: (msg: unknown) => Promise<void>;
}
```

---

## 五、返回格式

工具可以返回字符串或 `ToolResult`:

```typescript
// 返回字符串（自动转换为 ToolResult）
return '处理成功';

// 返回 ToolResult（MCP 兼容）
return {
  content: [
    { type: 'text', text: '处理结果' },
    { type: 'image', data: 'base64...', mimeType: 'image/png' },
  ],
  isError: false,
};
```

---

## 六、测试

```typescript
// tests/unit/my-tool.test.ts
import { describe, it, expect } from 'bun:test';
import { MyTool } from '../../extensions/tool/my-tool';
import { ToolRegistry } from '@microbot/sdk';
import type { ToolContext } from '@microbot/types';

describe('MyTool', () => {
  const registry = new ToolRegistry();
  registry.register(MyTool);

  const ctx: ToolContext = {
    channel: 'test',
    chatId: '123',
    workspace: '/tmp',
    currentDir: '/tmp',
    sendToBus: async () => {},
  };

  it('should process message', async () => {
    const result = await registry.execute('my_tool', { message: 'hello' }, ctx);
    expect(result).toContain('hello');
  });
});
```

---

## 七、配置

在 `settings.yaml` 中配置扩展:

```yaml
extensions:
  tools:
    - name: my_tool
      enabled: true
      config:
        # 工具特定配置
        apiKey: ${MY_API_KEY}
```
